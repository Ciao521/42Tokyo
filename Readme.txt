# NFT のデプロイと NFT によるアクセス制御のデモ

## 前準備

1. スマートコントラクト開発フレームワークである truffle と Openzeppelin が実装している NFT のパッケージをインストールする
   ```
   npm install
   ```
1. truffle を用いてローカルにブロックチェーンを立ち上げる
   ```
   npx truffle develop --log
   ```
   ```
   --log
   ```
   で動きをみることができる。＾Cを使うとその時点で、動作が終了してしまう。
   そのため、ターミナルを別で開いて、以下のコードを実行していく。
## NFT をデプロイする

1. スマートコントラクトのコードである DemoNFT721.sol をコンパイルする
   ```
   npx truffle compile
   ```
1. スマートコントラクトをデプロイする

   ```
   npx truffle migrate

   // 以下出力例
   Compiling your contracts...
   ===========================
   > Everything is up to date, there is nothing to compile.


   Starting migrations...
   ======================
   > Network name:    'development'
   > Network id:      5777
   > Block gas limit: 6721975 (0x6691b7)


   1_nftdemo_migration.js
   ======================

   Deploying 'DemoNFT721'
   ----------------------
   > transaction hash:    0xbbdfacae7f8835a1b9b4ac51125814b7752cfedaef25875f2ce327a5f510c640
   > Blocks: 0            Seconds: 0
   > contract address:    0x776f57E69D4d675b46c7eA9Ce380A8B0cbc5C01B
   > block number:        1
   > block timestamp:     1692336260
   > account:             0xC43f95CEf7Ab327328ca5666A9A7bBEB2bf7583b
   > balance:             99.991100587375
   > gas used:            2636863 (0x283c3f)
   > gas price:           3.375 gwei
   > value sent:          0 ETH
   > total cost:          0.008899412625 ETH

   > Saving artifacts
   -------------------------------------
   > Total cost:      0.008899412625 ETH

   Summary
   =======
   > Total deployments:   1
   > Final cost:          0.008899412625 ETH
   ```

1. 2 でデプロイした際のログに出ている `contract address` を環境変数に設定する.
   ```
   export CONTRACT_ADDRESS={contract address}
   ```
1. NFT を発行する
   ```
   node demo/mint.js
   ```
   //以下出力
   ```
   yasuhiro_iwai@ubuntu-2204-edr:~/intern/NFTdemo$ export CONTRACT_ADDRESS=0xe3C06523BFD8B41CC26BA2ED16A81c600473f900
   yasuhiro_iwai@ubuntu-2204-edr:~/intern/NFTdemo$ node demo/mint.js
   {
   transactionHash: '0xc7d9477cf08b3710e823361b769cc220c51668a2e5d75670fb45eaff44435365',
   transactionIndex: 0,
   blockNumber: 2,
   blockHash: '0x417ac27a579366a13ca1bc8177d73a32b590227b50335ba2065f012e9dba7c81',
   from: '0x2f6d487de1705340ef0b05ba416c9c7c89408549',
   to: '0xe3c06523bfd8b41cc26ba2ed16a81c600473f900',
   cumulativeGasUsed: 119665,
   gasUsed: 119665,
   contractAddress: null,
   logs: [
      {
         address: '0xe3C06523BFD8B41CC26BA2ED16A81c600473f900',
         blockHash: '0x417ac27a579366a13ca1bc8177d73a32b590227b50335ba2065f012e9dba7c81',
         blockNumber: 2,
         data: '0x',
         logIndex: 0,
         removed: false,
         topics: [Array],
         transactionHash: '0xc7d9477cf08b3710e823361b769cc220c51668a2e5d75670fb45eaff44435365',
         transactionIndex: 0,
         id: 'log_32fa4b0c'
      },
      {
         address: '0xe3C06523BFD8B41CC26BA2ED16A81c600473f900',
         blockHash: '0x417ac27a579366a13ca1bc8177d73a32b590227b50335ba2065f012e9dba7c81',
         blockNumber: 2,
         data: '0x0000000000000000000000000000000000000000000000000000000000000001',
         logIndex: 1,
         removed: false,
         topics: [Array],
         transactionHash: '0xc7d9477cf08b3710e823361b769cc220c51668a2e5d75670fb45eaff44435365',
         transactionIndex: 0,
         id: 'log_30903609'
      }
   ],
   logsBloom: '0x00000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000008008000000000000000440000000000000000000000000000020000000000000800000800000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000202000000000000000000000000000008000000002000000000000000000000000000000000000000000000000000060000000000000000000200000000000000000100000000000000000000000000000',
   status: true,
   effectiveGasPrice: 2000000000,
   type: '0x0'
   }
   ```
   
   ```
   develop:ganache   Transaction: 0xc7d9477cf08b3710e823361b769cc220c51668a2e5d75670fb45eaff44435365
   develop:ganache   Gas usage: 119665
   develop:ganache   Block number: 2
   develop:ganache   Block time: Tue Aug 22 2023 02:13:11 GMT+0000 (Coordinated Universal Time)
   develop:ganache  +26ms
   develop:ganache eth_getTransactionReceipt +1ms
   ```

1. NFT の情報を見る
   ```
   node demo/explore.js
   ```
   //以下出力
   ```
   0
   0x2F6d487De1705340EF0b05Ba416C9c7c89408549
   http://localhost:8080/vc
   ```
## NFT を用いてアクセス制御を行う

1. NFT を所持している人がアクセスできることを確認する

   ```
   node demo/accessControllDemo.js

   // 以下出力
   0xC43f95CEf7Ab327328ca5666A9A7bBEB2bf7583b
   0xC43f95CEf7Ab327328ca5666A9A7bBEB2bf7583b
   Access granted
   ```

1. 秘密鍵を環境変数で変更して NFT を所持していない人がアクセスできないことを確認する

   ```
   export PRIVATE_KEY=cf34751714c0779d0c8445e5799734ed78acf70eabbe88862cbab592709dca97
   node demo/accessControllDemo.js

   // 以下出力
   0x6B70cd9ED3c87265BC58EA0E62f548534523B01f
   0xC43f95CEf7Ab327328ca5666A9A7bBEB2bf7583b
   Access denied
   ```

以上
//ここから、オリジナル。
yasuhiro_iwai@ubuntu-2204-edr:~/intern$ cd LendaleSBT/
yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/mint.js
{
  transactionHash: '0x82c08fac44e259c3891d7ec8f748148ea9789d2e82c390e95a56b94d97d86f53',
  transactionIndex: 0,
  blockNumber: 2,
  blockHash: '0xbf57ba0f78a17d9d4eb0371ebe4e281f1aa471faf3e853924087528360ce34c3',
  from: '0x2f6d487de1705340ef0b05ba416c9c7c89408549',
  to: '0xe3c06523bfd8b41cc26ba2ed16a81c600473f900',
  cumulativeGasUsed: 97729,
  gasUsed: 97729,
  contractAddress: null,
  logs: [
    {
      address: '0xe3C06523BFD8B41CC26BA2ED16A81c600473f900',
      blockHash: '0xbf57ba0f78a17d9d4eb0371ebe4e281f1aa471faf3e853924087528360ce34c3',
      blockNumber: 2,
      data: '0x',
      logIndex: 0,
      removed: false,
      topics: [Array],
      transactionHash: '0x82c08fac44e259c3891d7ec8f748148ea9789d2e82c390e95a56b94d97d86f53',
      transactionIndex: 0,
      id: 'log_10a43936'
    },
    {
      address: '0xe3C06523BFD8B41CC26BA2ED16A81c600473f900',
      blockHash: '0xbf57ba0f78a17d9d4eb0371ebe4e281f1aa471faf3e853924087528360ce34c3',
      blockNumber: 2,
      data: '0x0000000000000000000000000000000000000000000000000000000000000001',
      logIndex: 1,
      removed: false,
      topics: [Array],
      transactionHash: '0x82c08fac44e259c3891d7ec8f748148ea9789d2e82c390e95a56b94d97d86f53',
      transactionIndex: 0,
      id: 'log_e22621bb'
    }
  ],
  logsBloom: '0x00000000000000000040000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000008008000000000000000440000000000000000000000000000020000000000000800000800000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000002000000001000000000000000100000000000000000000000000060000000000000000000000000000000000000100000000000000000000000000000',
  status: true,
  effectiveGasPrice: 2000000000,
  type: '0x0'
}

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/tokenURI.js 1
https://lendablesbt/example/1

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/setBaseURI.js https://lendablesbt/abc/
0x55f804b30000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001868747470733a2f2f6c656e6461626c657362742f6162632f0000000000000000
{
  transactionHash: '0x3f66a52c84007fc33dce84c37b05bcb6f7e058b88716f39d5335bff399e446d3',
  transactionIndex: 0,
  blockNumber: 6,
  blockHash: '0xc995ec035417f674be6266acbe8ba42038057e94423fd3368240a5d5cdb815c3',
  from: '0x2f6d487de1705340ef0b05ba416c9c7c89408549',
  to: '0xe3c06523bfd8b41cc26ba2ed16a81c600473f900',
  cumulativeGasUsed: 30662,
  gasUsed: 30662,
  contractAddress: null,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  effectiveGasPrice: 2000000000,
  type: '0x0'
}

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/tokenURI.js 1
https://lendablesbt/abc/1


yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/setRentalData.js 0xbe0f2b693387b5afc846dfa1aaa2f280c2d85f01 1 2023-08-31 1
Result {} 1 1693440000000 1
{
  transactionHash: '0x361489b0f90574a637ac7aad81d053f35f9013d2bde81d629f3e40e08a0c4303',
  transactionIndex: 0,
  blockNumber: 1,
  blockHash: '0x3bd77f4a9775ab5d8d390407995c6c8d4f517a18b7b4039d36b54917c05c55d1',
  from: '0x2f6d487de1705340ef0b05ba416c9c7c89408549',
  to: '0xe3c06523bfd8b41cc26ba2ed16a81c600473f900',
  cumulativeGasUsed: 21900,
  gasUsed: 21900,
  contractAddress: null,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  effectiveGasPrice: 2000000000,
  type: '0x0'
}

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/setRentalData.js 0xbe0f2b693387b5afc846dfa1aaa2f280c2d85f01 2 2023-08-01 1
Result {} 2 1690848000000 1
{
  transactionHash: '0x834de30331fbc6758390659b4e7f4ff9cc59228f955de42076047ca78fbadc74',
  transactionIndex: 0,
  blockNumber: 2,
  blockHash: '0x59c71d53c63e11ca683dfd7b06ac218b120b33027b20dee5a3aa75b7bdf0f5af',
  from: '0x2f6d487de1705340ef0b05ba416c9c7c89408549',
  to: '0xe3c06523bfd8b41cc26ba2ed16a81c600473f900',
  cumulativeGasUsed: 21900,
  gasUsed: 21900,
  contractAddress: null,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  effectiveGasPrice: 2000000000,
  type: '0x0'
}


yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/setRentalData.js 0xbe0f2b693387b5afc846dfa1aaa2f280c2d85f01 3 2023-08-01 10000000
Result {} 3 1690848000000 10000000
{
  transactionHash: '0xa86416277e3c7e3d47ebe9e6b2d55823903f5d37ebb7c6dcb2aff124ac6f4c9b',
  transactionIndex: 0,
  blockNumber: 3,
  blockHash: '0x56aea630b1617e8c59588b7363a19f5b510119fd5ff36426611089953d9330fd',
  from: '0x2f6d487de1705340ef0b05ba416c9c7c89408549',
  to: '0xe3c06523bfd8b41cc26ba2ed16a81c600473f900',
  cumulativeGasUsed: 21924,
  gasUsed: 21924,
  contractAddress: null,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  effectiveGasPrice: 2000000000,
  type: '0x0'
}

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/rent.js 1
{
  transactionHash: '0x6743fb144f809337d1426c4918dc86e7135690fd47ea782e5c57fc0520cafd88',
  transactionIndex: 0,
  blockNumber: 5,
  blockHash: '0xcf596745f984679da652a42ff863ef328ec8f1fb91a161df85b1ff2e59c7d828',
  from: '0xbe0f2b693387b5afc846dfa1aaa2f280c2d85f01',
  to: '0xe3c06523bfd8b41cc26ba2ed16a81c600473f900',
  cumulativeGasUsed: 21204,
  gasUsed: 21204,
  contractAddress: null,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  effectiveGasPrice: 2000000000,
  type: '0x0'
}

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/getRentalData.js 0xbe0f2b693387b5afc846dfa1aaa2f280c2d85f01 1
[ '0', false, '0', expire: '0', isRented: false, rewardAmount: '0' ]

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/accessControll.js 0xbe0f2b693387b5afc846dfa1aaa2f280c2d85f01 1
0x2F6d487De1705340EF0b05Ba416C9c7c89408549
0x2F6d487De1705340EF0b05Ba416C9c7c89408549
Access granted

yasuhiro_iwai@ubuntu-2204-edr:~/intern/LendaleSBT$ node demo/accessControll.js 0x8b707a3283db61fab6b1c4922b5574befd23a654 1
0x8b707A3283DB61FAb6B1C4922B5574BefD23A654
0x2F6d487De1705340EF0b05Ba416C9c7c89408549
Access denied